# Ansible Doc

- [Ansible Doc](#ansible-doc)
  - [Install Ansible](#install-ansible)
  - [Integrating Ansible into Azure Cloud Shell](#integrating-ansible-into-azure-cloud-shell)
  - [Ansible artifacts](#ansible-artifacts)
  - [Configuring Ansible](#configuring-ansible)
  - [Creating an inventory for targeting Ansible hosts](#creating-an-inventory-for-targeting-ansible-hosts)
  - [The inventory file](#the-inventory-file)
  - [Configuring hosts in the inventory](#configuring-hosts-in-the-inventory)
    - [Testing the inventory](#testing-the-inventory)
  - [Writing the first playbook](#writing-the-first-playbook)
    - [Understanding Ansible Modules](#understanding-ansible-modules)
    - [Improving your playbook with roles](#improving-your-playbook-with-roles)
  - [Executing Ansible](#executing-ansible)
    - [Using the preview or dry run option](#using-the-preview-or-dry-run-option)
    - [Increasing the log level output](#increasing-the-log-level-output)

## Install Ansible

Ansible is not multiplatform and can therefore only be installed on the following OSes:

- Red Hat
- Debian
- CentOS
- macOS

To install Ansible on Ubuntu use the following script:

```bash

sudo apt-get update
sudo apt-get install software-properties-common
sudo apt-add-repository --yes --update ppa:ansible/ansible
sudo apt-get install ansible

```

Ansible cannot be installed on Windows but you can use WSL for that.
If you have Visual Studio Code with the remote development extension installed
you can install ansible with Visual Studio Code.

To check if Ansible is installed run the following script:

```bash
ansible --version
```

To display all usable Ansible command run this script:

```bash
ansible --help
```

## Integrating Ansible into Azure Cloud Shell

Start an Azure Cloud Shell by navigating to [Azure Cloud Shell](https://shell.azure.com)
and check the installation of ansible with the following command:

```bash
ansible --help
```

## Ansible artifacts

If you will use Ansible you need several main artifacts:

- The hosts: the target systems that Ansible will configure. This can also be localhost
- The inventory: This is an INI or YAML file that contains the list of target hosts on which Ansible
will perform configuration actions. The inventory can also be script based. This is the case if you use a dynamic
inventory.
- The playbook: This is the Ansible configuration script that will be executed to configure hosts.

## Configuring Ansible

The default configuration of Ansible is stored in /etc/ansible/ansible.cfg. This Ansible configuration file
is already filled with a sample configuration which can be changed by the user at any time.

We can also view the ansible.cfg by using the following command:

```bash
ansible-config view
```

## Creating an inventory for targeting Ansible hosts

This is a list of all hosts which are configured by Ansible. There are two types of invetories:

- Static inventory: Hosts are listed in a text file in INI or YAML format. This is the basic mode of Ansible
inventory. That static inventory can only be used if we know the host addresses.
- Dynamic inventory: The list of hosts is dynamically generated by an external script (for example, with a Python script).
The dynamic inventory is used in case we do not have the addresses of the hosts.

## The inventory file

For Ansible to configure hosts when running the playbook, it needs to have a file that contains the list of hosts,
that is, the list of IP or FQDN addresses of the target machines. This list of hosts is noted in a static file called the
inventory file.

Ansible creates a sample inventory file in /etc/ansible/hosts but we can create our own inventory file and place It
where ever we like.

So let's create a folder called devopsansible with this script:

```bash
mkdir devopsansible
cd devopsansible
```

Create a file called myinventory with this script:

```bash
touch myinventory
```

now we put localhost into the file.

When Ansible is executed based on this inventory, It will execute all of the requested actions (playbooks) on all hosts
mentioned in this inventory.

In a bigger environment the same Ansible code contains the configuration action performed for all of the VMs of an application.
Since these VMs have different role within the application we must divide our inventory to properly seperate the VMs by functional roles.

To group VMs by roles in the inventory we have to create groups in the inventory file. A group is written inside []. A sample inventory
can look like this:

```bash

[webserver]
server1

[database]
server2

```

## Configuring hosts in the inventory

To tell Ansible how to communicate with the hosts in the inventory file you can override the following variables:

- ansible_user: The user who connects to the remote host
- ansible_port: The port where ansible needs to connect to
- ansible_host: The alias of the host
- ansible_connection: This is the type of connection to the remote host. and can be Paramiko, SSH or local
- ansible_private_key_file: This is the private key used to connect to the remote host.

So a sample inventory file with that variables can look like this:

```bash
[webserver]
server1 ansible_host=192.168.0.2 ansible_port=2222

[database]
server2 ansible_host=192.168.0.3 ansible_port=2222 ansible_user=admin
```

### Testing the inventory

we can test the following inventory with this line of code:

```bash
ansible -i myinventory all -u constantinhager -m ping
```

- -i: the path of the inventory file.
- -u: the name of the remote user.
- -m: the command to execute.

If we want to test the ansible connection only on a specific group you can execute the following command:

```bash
ansible -i myinventory webserver -u constantinhager -m ping
```

## Writing the first playbook

The code of a playbook is written in yaml. The Ansible playbook is, therefore, a sequence of actions that are encoded
in Ansible modules.

### Understanding Ansible Modules

The complete list of built in Ansible modules is available here: [Ansible modules list](https://docs.ansible.com/ansible/latest/modules/list_of_all_modules.html)

### Improving your playbook with roles

If you have a repetitive task you need to encapsulate the task into an Ansible module. To do that we need to create a folder called "role"
that can be used by several playbooks.

A sample folder structure could look like this:

Root
    inventory
    Playbook.yml
    roles
      nginx
        tasks
          main.yml

We can write our own Ansible module or use Ansible galaxy [Ansible Galaxy](https://galaxy.ansible.com), where we can download the
roles from the Ansible community.

## Executing Ansible

To run an Ansible playbook execute the following command:

```bash
ansible-playbook -i inventory playbook.yml
```

Parameters:
 -i : the inventory file path
 playbook.yml: the path of the Ansible playbook to execute.

If you execute an Ansible playbook the following sequence will be executed:

- Gathering facts: Ansible checks that the hosts are reachable.
- The tasks playbook is executed on hosts.
- Play Recap: This is the status of the changes that were executed on each host; the value of this status can be as follows:

| State  | Explanation  |
|---|---|
| ok  |  This is the number of playbook tasks that have been correctly applied to the host. |
| changed  |  This is the number of changes applied |
| unreachable  | The host is unreachable  |
| failed | Execution failed on this host. |

If an existing Ansible playbook needs to be modified and is executed again not the complete Ansible
playbook is executed. Only changes of the Ansible playbook are executed.

We can also add some useful option to this command to provide the following:

- A preview of Ansible changes before applying the changes
- More logs in the execution output.

### Using the preview or dry run option

To check if the steps in a playbook are correct we can preview the changes that
we make with the steps. To do that we use the --check parameter in the ansible-playbook command

```bash
ansible-playbook -i inventory playbook.yml --check
```

With this parameter no changes to the hosts are made but the preview shows what changes
could have been made by the Ansible playbook.

### Increasing the log level output

There are three log levels in Ansible they are listed below

| Log Level | Explanation |
| --------- | ----------  |
| -v        | basic verbose mode |
| -vvv      | verbose mode with more outputs |
| -vvvv     | verbose mode and the connection debugging information |

The following command will display basic verbose mode

```bash
ansible-playbook -i inventory playbook.yml -v
```

The complete documentation on the ansible-playbook command is available here:
[ansible-playbook documentation](https://docs.ansible.com/ansible/2.4/ansible-playbook.html)

